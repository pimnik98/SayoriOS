/**
 * @file drv/input/mouse.c
 * @author Пиминов Никита (nikita.piminoff@yandex.ru), Рустем Гимадутдинов (https://github.com/rgimad/EOS)
 * @brief Драйвер мыши
 * @version 0.3.2
 * @date 2022-12-11
 * @copyright Copyright SayoriOS Team (c) 2022-2023
 */

#include <kernel.h>
#include <io/ports.h>
#include <drv/input/mouse.h>

uint8_t mouse_ready = 0;        ///< Готова ли мышь к работе

int32_t mouse_x  = 0;           ///< Позиция мыши по X
int32_t mouse_y  = 0;           ///< Позиция мыши по Y

uint8_t mouse_b1 = 0;           ///< Левая кнопка мыши
uint8_t mouse_b2 = 0;           ///< Правая кнопка мыши
uint8_t mouse_b3 = 0;           ///< Средняя кнопка мыши
uint8_t mouse_b4 = 0;           ///< ???
uint8_t mouse_b5 = 0;           ///< ???
bool show_mouse_cursor = false;

int mouse_wheel = 0;            ///< После каждого чтения меняем на 0

// cursor image in format 0xAARRGGBB
uint32_t cursor[32][32] = {
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X84000000,0X06000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XBC000000,0X0C000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0XCA000000,0X14000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0XFF000000,0XD7000000,0X1D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0XB8000000,0XFF000000,0XE2000000,0X28000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X0C000000,0XA0000000,0XFF000000,0XEB000000,0X35000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0X01000000,0X8D000000,0XFF000000,0XF3000000,0X43000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0X79000000,0XFF000000,0XF9000000,0X54000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X65000000,0XFD000000,0XFD000000,0X66000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X53000000,0XF8000000,0XFF000000,0X79000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X43000000,0XF3000000,0XFF000000,0X8E000000,0X01000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X34000000,0XEB000000,0XFF000000,0XA1000000,0X04000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X27000000,0XE2000000,0XFF000000,0XB2000000,0X08000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X1C000000,0XD6000000,0XFF000000,0XC2000000,0X0F000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X13000000,0XCA000000,0XFF000000,0XCF000000,0X17000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X0C000000,0XBB000000,0XFF000000,0XDC000000,0X21000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X06000000,0XAA000000,0XFF000000,0XE6000000,0X2D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X02000000,0X98000000,0XFF000000,0XEE000000,0X3A000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X30000000,0X40000000,0X51000000,0X61000000,0X71000000,0X81000000,0X92000000,0XF1000000,0XFF000000,0XF5000000,0X49000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0XBE000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFF000000,0XFA000000,0X58000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0XFFFFFFFF,0X3C000000,0X8D000000,0XFFFFFFFF,0XFFFFFFFF,0X4D000000,0XFF000000,0XED000000,0X7C000000,0X6C000000,0X5C000000,0X4C000000,0X3C000000,0X2C000000,0X1D000000,0X0D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0XFFFFFFFF,0X43000000,0XF4000000,0XF7000000,0X14000000,0XFFFFFFFF,0X02000000,0XDB000000,0XFF000000,0X2D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0XFFFFFFFF,0X4B000000,0XF7000000,0XFF000000,0XFF000000,0X7B000000,0XFFFFFFFF,0XFFFFFFFF,0X6C000000,0XFF000000,0X9D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X08000000,0X54000000,0XFA000000,0XFD000000,0X86000000,0XFE000000,0XE6000000,0X05000000,0XFFFFFFFF,0X0C000000,0XF0000000,0XF8000000,0X16000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0X65000000,0XFC000000,0XFC000000,0X5C000000,0X00FFFFFF,0XB4000000,0XFF000000,0X5B000000,0XFFFFFFFF,0XFFFFFFFF,0X8B000000,0XFF000000,0X7E000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0XFE000000,0XFA000000,0X53000000,0X00FFFFFF,0X00FFFFFF,0X43000000,0XFF000000,0XCC000000,0XFFFFFFFF,0XFFFFFFFF,0X1F000000,0XFC000000,0XE8000000,0X06000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XFF000000,0XF7000000,0X4A000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD2000000,0XFF000000,0X3C000000,0XFFFFFFFF,0XFFFFFFFF,0XAA000000,0XFF000000,0X5F000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XD8000000,0XF4000000,0X42000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X62000000,0XFF000000,0XAC000000,0XFFFFFFFF,0XFFFFFFFF,0X3A000000,0XFF000000,0XD0000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0XC8000000,0X3A000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X07000000,0XEA000000,0XFC000000,0X1F000000,0X03000000,0X55000000,0XF7000000,0XFF000000,0X41000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X1D000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X81000000,0XFF000000,0XBF000000,0XDF000000,0XFF000000,0XFF000000,0XD5000000,0X46000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X17000000,0XF9000000,0XFF000000,0XFE000000,0XB8000000,0X47000000,0X01000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF},
{0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X96000000,0X99000000,0X2A000000,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF,0X00FFFFFF}
}; ///< Рисунок мыши

uint32_t under_cursor[32][32];  ///< Старый буфер мыши

/**
 * @brief Структура данных пакета от мыши
 */
typedef struct mouse_flags_byte {
    unsigned int left_button   : 1;
    unsigned int right_button  : 1;
    unsigned int middle_button : 1;

    unsigned int always1 : 1;

    unsigned int x_sign : 1;
    unsigned int y_sign : 1;

    unsigned int x_overflow : 1;
    unsigned int y_overflow : 1;
} __attribute__((packed)) mouse_flags_byte;


/**
 * @brief Структура данных пакета от мыши
 */
struct dev_ps2m_mouse_packet {
    int16_t movement_x;
    int16_t movement_y;
    uint8_t button_l;
    uint8_t button_m;
    uint8_t button_r;
} ps2m_buffer;

/**
 * @brief Инициализирована ли мышь?
 *
 * @return bool - Да/Нет
 */
bool isMouseInit(){
    return mouse_ready==1?true:false;
}

void mouse_set_show_system_cursor(bool set) {
    show_mouse_cursor = set;
}

bool mouse_get_show_system_cursor() {
    return show_mouse_cursor;
}

/**
 * @brief Парсинг пакета мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_parse_packet(const char *buf, uint8_t has_wheel, uint8_t has_5_buttons) {
    mouse_flags_byte *mfb = (mouse_flags_byte*) (buf);
    if (mfb->x_overflow || mfb->y_overflow || !mfb->always1) {
        return;
    }

    int offx = (int16_t) (0xff00 * mfb->x_sign) | buf[1];
    int offy = (int16_t) (0xff00 * mfb->y_sign) | buf[2];
    mouse_x += offx;
    mouse_y -= offy;
    mouse_b1 = mfb->left_button;
    mouse_b2 = mfb->right_button;
    mouse_b3 = mfb->middle_button;
    ps2m_buffer.movement_x = offx;
    ps2m_buffer.movement_y = offy;
    ps2m_buffer.button_l = mouse_b1;
    ps2m_buffer.button_r = mouse_b2;
    ps2m_buffer.button_m = mouse_b3;

    if (has_wheel) {
        mouse_wheel += (char) ((!!(buf[3] & 0x8)) * 0xf8 | (buf[3] & 0x7));
        if (has_5_buttons) {
            mouse_b4 = !!(buf[3] & 0x20);
            // parse buttons 4-5 (byte 3, bits 4-5)
        }
    }
}

/**
 * @brief Затирает прошлое место положение мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_erase() {
    for (int i = 0; i < 32; ++i) {
        for (int j = 0; j < 32; ++j) {
            set_pixel(mouse_x + j - 1, mouse_y + i - 1, under_cursor[i][j]);
        }
    }
}

/**
 * @brief Рисует мышь
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_draw() {
    for (int i = 0; i < 32; i++) {
        for (int j = 0; j < 32; j++) {
            under_cursor[i][j] = getPixel(mouse_x + j - 1, mouse_y + i - 1);
        }
    }
    rgba_color rc;
    for (int i = 0; i < 32; ++i) {
        for (int j = 0; j < 32; ++j) {
            rc.b = cursor[i][j] & 0xFF;
            rc.g = (cursor[i][j] >> 8) & 0xFF;
            rc.r = (cursor[i][j] >> 16) & 0xFF;
            rc.a = (cursor[i][j] >> 24) & 0xFF;

            // set_pixel(mouse_x + j - 1, mouse_y + i - 1, cursor[i][j]);
            setPixelAlpha(mouse_x + j - 1, mouse_y + i - 1, rc);
        }
    }
}

/**
 * @brief Обработчик мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика ядра!
 */
void mouse_handler(__attribute__((unused)) struct registers r) {
    uint8_t status = inb(0x64);
    if ((status & 1) == 0 || (status >> 5 & 1) == 0) {
        return;
    }

    static int recbyte = 0;
    static char mousebuf[5];

    mousebuf[recbyte++] = inb(0x60);
    if (recbyte == 3 /* + has_wheel */) {
        recbyte = 0;

        static uint8_t drawn = 0;
        if (drawn && show_mouse_cursor) {
            mouse_erase();
        }
        drawn = 1;

        mouse_parse_packet(mousebuf, 0, 0);

        // Bounds
        if (mouse_x < 0) mouse_x = 0;
        if (mouse_y < 0) mouse_y = 0;
        if (mouse_x > (int) (getWidthScreen())) mouse_x = getWidthScreen();
        if (mouse_y > (int) (getHeightScreen())) mouse_y = getHeightScreen(); //-10;

        // Redraw the cursor
        if(show_mouse_cursor) mouse_draw();
    }
}

/**
 * @brief Ожидание ответа мыши
 *
 * @param uint8_t a_type - Тип отправляемых данных
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_wait(uint8_t a_type) {
    uint32_t _time_out = 100;
    if (a_type == 0) {
        while (_time_out--) { //Data
            if ((inb(0x64) & 1) == 1) {
                return;
            }
        }
        return;
    } else {
        while (_time_out--) { //Signal
            if ((inb(0x64) & 2) == 0) {
                return;
            }
        }
        return;
    }
}

/**
 * @brief Отправка данных для мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_write(uint8_t a_write) { //unsigned char
    // Ожидаем возможности, пока можно будет отправить команду
    mouse_wait(1);
    // Говорим мышке, что мы отправляем команду
    outb(0x64, 0xD4);
    // Ожидаем ответа
    mouse_wait(1);
    // Отправляем данные
    outb(0x60, a_write);
}

/**
 * @brief Считывание данных с мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
uint8_t mouse_read() {
    // Получаем ответ от мыши
    mouse_wait(0);
    return inb(0x60);
}

/**
 * @brief Установщик драйвера мыши
 *
 * @warning Не нужно вызывать самостоятельно, только для обработчика мыши!
 */
void mouse_install() {
    memset(under_cursor, 0, 32 * 32 * sizeof(uint32_t));
    uint8_t _status;  //unsigned char

    // Включить вспомогательное устройство мыши
    mouse_wait(1);
    outb(0x64, 0xA8);

    // Включить прерывания
    mouse_wait(1);
    outb(0x64, 0x20);
    mouse_wait(0);
    _status = (inb(0x60) | 2);
    mouse_wait(1);
    outb(0x64, 0x60);
    mouse_wait(1);
    outb(0x60, _status);

    // Скажите мыши использовать настройки по умолчанию
    mouse_write(0xF6);
    mouse_read(); // Acknowledge

    // Включить мышь
    mouse_write(0xF4);
    mouse_read(); // Acknowledge

    // Установить координаты курсора в середине экрана
    mouse_x = getWidthScreen() / 2;
    mouse_y = getHeightScreen() / 2;

    register_interrupt_handler(IRQ12, &mouse_handler);
    mouse_ready = 1;
    qemu_log("[MOUSE] Status: %x | %d",_status,_status);
}

uint32_t mouse_get_x() {return mouse_x;}
uint32_t mouse_get_y() {return mouse_y;}
uint8_t  mouse_get_b1() {return mouse_b1;}
uint8_t  mouse_get_b2() {return mouse_b2;}
uint8_t  mouse_get_b3() {return mouse_b3;}
uint8_t  mouse_get_b4() {return mouse_b4;}
uint8_t  mouse_get_b5() {return mouse_b5;}
